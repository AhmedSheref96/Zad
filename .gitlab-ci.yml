stages:
  - development
  - production

variables:
  SECURE_FILE_NAME: "google-service-secrets.json"
  JAVA_VERSION: "17"
  LC_ALL: "en_US.UTF-8"
  LANG: "en_US.UTF-8"
  CI_DEBUG_TRACE: "true"

image: cirrusci/android-sdk:33

before_script:
  - apt-get update -qq && apt-get install -y -qq ruby-full unzip
  - gem install bundler
  - bundle install

deploy-to-development:
  stage: development
  script:
    - echo "Checking Secure Files..."
    - ls -la $CI_SECURE_FILES
    - chmod 644 $CI_SECURE_FILES/google-service-secrets.json
    - cp $CI_SECURE_FILES/${SECURE_FILE_NAME} ./
    - chmod 644 ${SECURE_FILE_NAME}
    - ls -la
    - bundle exec fastlane distribute_development
  rules:
    - if: '$CI_COMMIT_REF_NAME == "development"'
    - if: '$CI_COMMIT_TAG =~ /^v-dev-/'

deploy-to-production:
  stage: production
  script:
    - cp $CI_SECURE_FILES/${SECURE_FILE_NAME} ./
    - chmod 644 ${SECURE_FILE_NAME}
    - bundle exec fastlane distribute_production
  rules:
    - if: '$CI_COMMIT_REF_NAME == "main" && $CI_COMMIT_TAG =~ /^v-prod-/'

after_script:
  - rm -f ${SECURE_FILE_NAME}